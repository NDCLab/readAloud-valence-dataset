#title: "syllabic-coding.Rmd"
#author: "Jessica M. Alexander"
#input: coded mantis file (CSV), currently in code/ folder
#output: preprocessed mantis file (CSV), in derivates/preprocessed/ folder


#set up libraries
library(lubridate)

#read in coded file, drop coding column 1, name rows, assign numbers to columns
path <- '/Users/jessraissouni/github/readAloud-valence-dataset/code/'
filename <- 'example_mantis'
ext <- '.csv'
df <- read.csv(paste(path,filename,ext, sep = "", collapse = NULL))

df <- df[-c(1)]
rownames(df) <- c("hesitate", "mispronounce", "duplicate", "drop", "onset", "end")
colnames(df) <- c(1:ncol(df))


#HARD CODING OF PASSAGE-SPECIFIC LOCATIONS
#establish location of start, switch point, and end
first_syll <- 1
switch_syll <- 168
last_syll <- 361

#establish locations of preswitch group, switch group, and postswitch group
pre_start <- 159
pre_end <- 165
switch_start <- 166
switch_end <- 174
post_start <- 175
post_end <- 185

#CALCULATE SPEED OF TWO PASSAGE HALVES
#establish chronology of the task: start of the negative passage portion, start of the positive passage portion, and end
first_half_onset <- as.integer(minute(hms(df[5,first_syll]))*60 + second(hms(df[5,first_syll])))
first_half_end <- as.integer(minute(hms(df[6,(switch_syll-1)]))*60 + second(hms(df[6,(switch_syll-1)])))
second_half_end <- as.integer(minute(hms(df[6,last_syll]))*60 + second(hms(df[6,last_syll])))

#drop from dataframe the chronology rows, leaving only the disfluency codes (1=error, 0=non-error)
df <- df[-c(5:6),]

#convert columns that previously had chronology points (first_syll, one prior to switch_syll, and last_syll) to integer values
df[first_syll] <- as.integer(unlist(df[first_syll]))
df[(switch_syll-1)] <- as.integer(unlist(df[(switch_syll-1)]))
df[last_syll] <- as.integer(unlist(df[last_syll]))

#establish syllabic lengths of each passage half
first_half_length <- ncol(df[1:(switch_syll-1)])
second_half_length <- ncol(df[switch_syll:last_syll])

#calculate reading speed of positive and negative passage portions (syllables/second)
first_half_speed <- (first_half_end - first_half_onset)/first_half_length
second_half_speed <- (second_half_end - first_half_end)/second_half_length


#CALCULATE ERROR RATES IN PASSAGE HALVES AND SWITCH GROUPS
#establish error count by type of error in each passage half
cum_error_first <- lapply(rowSums(df[,1:(switch_syll-1)]), sum)
error_hes_first <- cum_error_first$hesitate
error_mis_first <- cum_error_first$mispronounce
error_dup_first <- cum_error_first$duplicate
error_drop_first <- cum_error_first$drop

cum_error_second <- lapply(rowSums(df[,switch_syll:last_syll]), sum)
error_hes_second <- cum_error_second$hesitate
error_mis_second <- cum_error_second$mispronounce
error_dup_second <- cum_error_second$duplicate
error_drop_second <- cum_error_second$drop

#calculate total number of erroneous syllables in each passage half, along with error rate
first_half_total_error <- 0
for(i in 1:(switch_syll-1)) {
  col_total <- sum(df[,i])
  if(col_total == 0) {
  next
  }
    first_half_total_error <- first_half_total_error + 1
}
first_half_error_rate <- first_half_total_error/first_half_length

second_half_total_error <- 0
for(i in switch_syll:last_syll) {
  col_total <- sum(df[,i])
  if(col_total == 0) {
  next
  }
    second_half_total_error <- second_half_total_error + 1
}
second_half_error_rate <- second_half_total_error/second_half_length

#create mini dataframes for preswitch group, switch group, and postswitch group
preswitch <- df[,pre_start:pre_end]
switch <- df[,switch_start:switch_end]
postswitch <- df[,post_start:post_end]

#establish syllabic lengths of preswitch group, switch group, and postswitch group
preswitch_length <- ncol(preswitch)
switch_length <- ncol(switch)
postswitch_length <- ncol(postswitch)

#establish error count by type of error in preswitch group, switch group, and postswitch group
cum_error_pre <- lapply(rowSums(preswitch[,1:ncol(preswitch)]), sum)
error_hes_pre <- cum_error_pre$hesitate
error_mis_pre <- cum_error_pre$mispronounce
error_dup_pre <- cum_error_pre$duplicate
error_drop_pre <- cum_error_pre$drop

cum_error_switch <- lapply(rowSums(switch[,1:ncol(switch)]), sum)
error_hes_switch <- cum_error_switch$hesitate
error_mis_switch <- cum_error_switch$mispronounce
error_dup_switch <- cum_error_switch$duplicate
error_drop_switch <- cum_error_switch$drop

cum_error_post <- lapply(rowSums(postswitch[,1:ncol(postswitch)]), sum)
error_hes_post <- cum_error_post$hesitate
error_mis_post <- cum_error_post$mispronounce
error_dup_post <- cum_error_post$duplicate
error_drop_post <- cum_error_post$drop

#calculate total number of erroneous syllables in preswitch group, switch group, and postswitch group, along with error rate
preswitch_total_error <- 0
for(i in 1:ncol(preswitch)) {
  col_total <- sum(preswitch[,i])
  if(col_total == 0) {
  next
  }
    preswitch_total_error <- preswitch_total_error + 1
}
preswitch_error_rate <- preswitch_total_error/preswitch_length

switch_total_error <- 0
for(i in 1:ncol(switch)) {
  col_total <- sum(switch[,i])
  if(col_total == 0) {
  next
  }
    switch_total_error <- switch_total_error + 1
}
switch_error_rate <- switch_total_error/switch_length

postswitch_total_error <- 0
for(i in 1:ncol(postswitch)) {
  col_total <- sum(postswitch[,i])
  if(col_total == 0) {
  next
  }
    postswitch_total_error <- postswitch_total_error + 1
}
postswitch_error_rate <- postswitch_total_error/postswitch_length

#OUTPUT PREPROCESSED CSV
#build dataframe
output <- data.frame("first_half_length" = c(first_half_length),
                    "second_half_length" = c(second_half_length),
                    "first_half_speed" = c(first_half_speed),
                    "second_half_speed" = c(second_half_speed),
                    "first_half_total_error" = c(first_half_total_error),
                    "second_half_total_error" = c(second_half_total_error),
                    "first_half_error_rate" = c(first_half_error_rate),
                    "second_half_error_rate" = c(second_half_error_rate),
                    "error_hes_first" = c(error_hes_first),
                    "error_mis_first" = c(error_mis_first),
                    "error_dup_first" = c(error_dup_first),
                    "error_drop_first" = c(error_drop_first),
                    "error_hes_second" = c(error_hes_second),
                    "error_mis_second" = c(error_mis_second),
                    "error_dup_second" = c(error_dup_second),
                    "error_drop_second" = c(error_drop_second),
                    "preswitch_length" = c(preswitch_length),
                    "switch_length" = c(switch_length),
                    "postswitch_length" = c(postswitch_length),
                    "preswitch_total_error" = c(preswitch_total_error),
                    "switch_total_error" = c(switch_total_error),
                    "postswitch_total_error" = c(postswitch_total_error),
                    "preswitch_error_rate" = c(preswitch_error_rate),
                    "switch_error_rate" = c(switch_error_rate),
                    "postswitch_error_rate" = c(postswitch_error_rate),
                    "error_hes_pre" = c(error_hes_pre),
                    "error_mis_pre" = c(error_mis_pre),
                    "error_dup_pre" = c(error_dup_pre),
                    "error_drop_pre" = c(error_drop_pre),
                    "error_hes_switch" = c(error_hes_switch),
                    "error_mis_switch" = c(error_mis_switch),
                    "error_dup_switch" = c(error_dup_switch),
                    "error_drop_switch" = c(error_drop_switch),
                    "error_hes_post" = c(error_hes_post),
                    "error_mis_post" = c(error_mis_post),
                    "error_dup_post" = c(error_dup_post),
                    "error_drop_post" = c(error_drop_post)
                    )

output_path <- '/Users/jessraissouni/github/readAloud-valence-dataset/derivatives/preprocessed/'
write.csv(output, paste(output_path,filename,"_preproc_", today(), ext, sep = "", collapse = NULL), row.names=FALSE)